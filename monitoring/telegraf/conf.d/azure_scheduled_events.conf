# Azure Scheduled Events Input Plugin Configuration
# Collects Azure VM scheduled events via the Instance Metadata Service (IMDS)
# Follows Microsoft best practices for IMDS usage and rate limiting

# Azure Scheduled Events Input
[[inputs.http]]
  name_override = "azure_scheduled_events"
  urls = ["http://169.254.169.254/metadata/scheduledevents?api-version=2020-07-01"]
  method = "GET"
  timeout = "10s"
  interval = "30s"
  data_format = "json"
  json_string_fields = ["EventId", "EventType", "ResourceType", "EventStatus", "EventSource", "NotBefore", "Description"]
  
  [inputs.http.headers]
    Metadata = "true"
    User-Agent = "telegraf-azure-events/1.0"

  [inputs.http.tags]
    azure_service = "scheduled_events"
    cloud_provider = "azure"
    metric_source = "imds"
    imds_version = "2020-07-01"
    rate_limit_compliance = "true"

# Azure VM Metadata Input  
[[inputs.http]]
  name_override = "azure_vm_metadata"
  urls = ["http://169.254.169.254/metadata/instance/compute?api-version=2021-12-13"]
  method = "GET"
  timeout = "10s"
  interval = "300s"
  data_format = "json"
  json_string_fields = ["location", "name", "resourceGroupName", "vmSize", "zone", "osType", "publisher", "offer", "sku", "platformFaultDomain", "platformUpdateDomain", "placementGroupId", "vmScaleSetName", "priority"]
  
  [inputs.http.headers]
    Metadata = "true"
    User-Agent = "telegraf-azure-metadata/1.0"

  [inputs.http.tags]
    azure_service = "vm_metadata"
    cloud_provider = "azure"
    metric_source = "imds"

# Custom processor to add event status metrics and handle data privacy
[[processors.starlark]]
  script = "def apply(metric):\n    if metric.name == 'azure_scheduled_events':\n        metric.fields['event_count'] = 1\n        event_type = metric.tags.get('EventType', '')\n        if event_type in ['Reboot', 'Redeploy']:\n            metric.tags['severity'] = 'high'\n        elif event_type in ['Freeze', 'Preempt']:\n            metric.tags['severity'] = 'critical'\n        else:\n            metric.tags['severity'] = 'medium'\n        description = metric.fields.get('Description', '')\n        if 'Planned' in description:\n            metric.tags['maintenance_type'] = 'planned'\n        else:\n            metric.tags['maintenance_type'] = 'unplanned'\n    elif metric.name == 'azure_vm_metadata':\n        metric.fields['vm_health_check'] = 1\n        if 'zone' in metric.fields and metric.fields['zone']:\n            metric.tags['availability_zone'] = str(metric.fields['zone'])\n            metric.fields['zone_configured'] = 1\n        else:\n            metric.fields['zone_configured'] = 0\n    return metric"

# Health check for the Azure IMDS endpoint
# Uses minimal endpoint to check IMDS availability without sensitive data
[[inputs.http_response]]
  name_override = "azure_imds_health"
  
  ## URLs to check (using minimal metadata endpoint)
  urls = [
    "http://169.254.169.254/metadata/instance/compute/location?api-version=2021-12-13&format=text"
  ]

  ## HTTP method
  method = "GET"

  ## Required HTTP headers for IMDS
  [inputs.http_response.headers]
    Metadata = "true"
    User-Agent = "telegraf-imds-health/1.0"

  ## Expected response status code
  expected_response_status_code = 200

  ## HTTP request timeout (Microsoft recommends max 10s)
  timeout = "10s"

  ## Interval for health checks (respects rate limiting)
  interval = "60s"
  
  ## Response time tracking
  response_timeout = "10s"

  ## Additional tags
  [inputs.http_response.tags]
    service = "azure_imds"
    check_type = "health"
    cloud_provider = "azure"