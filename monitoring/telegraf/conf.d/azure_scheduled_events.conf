# Azure Scheduled Events Input Plugin Configuration
# Collects Azure VM scheduled events via the Instance Metadata Service (IMDS)
# Follows Microsoft best practices for IMDS usage and rate limiting

# Azure Scheduled Events Input
[[inputs.http]]
  name_override = "azure_scheduled_events"
  urls = ["http://169.254.169.254/metadata/scheduledevents?api-version=2020-07-01"]
  method = "GET"
  timeout = "10s"
  interval = "30s"
  data_format = "json"
  json_string_fields = ["EventId", "EventType", "ResourceType", "EventStatus", "EventSource", "NotBefore", "Description"]
  
  [inputs.http.headers]
    Metadata = "true"
    User-Agent = "telegraf-azure-events/1.0"

  [inputs.http.tags]
    azure_service = "scheduled_events"
    cloud_provider = "azure"
    metric_source = "imds"
    imds_version = "2020-07-01"
    rate_limit_compliance = "true"

# Azure VM Metadata Input - Basic Fields
[[inputs.http]]
  name_override = "azure_vm_metadata"
  urls = ["http://169.254.169.254/metadata/instance/compute?api-version=2025-04-07&format=json"]
  method = "GET"
  timeout = "10s"
  interval = "300s"
  data_format = "json"
  
  [inputs.http.headers]
    Metadata = "true"
    User-Agent = "telegraf-azure-metadata/1.0"

  [inputs.http.tags]
    azure_service = "vm_metadata"
    cloud_provider = "azure"
    metric_source = "imds"

# Azure VM Zone Information - Specific Endpoints
[[inputs.http]]
  name_override = "azure_vm_zone"
  urls = ["http://169.254.169.254/metadata/instance/compute/zone?api-version=2025-04-07&format=text"]
  method = "GET"
  timeout = "10s"
  interval = "300s"
  data_format = "value"
  data_type = "string"
  
  [inputs.http.headers]
    Metadata = "true"
    User-Agent = "telegraf-azure-zone/1.0"

  [inputs.http.tags]
    azure_service = "vm_zone"
    cloud_provider = "azure"
    metric_source = "imds"
    zone_type = "logical"

# Azure VM Location Information
[[inputs.http]]
  name_override = "azure_vm_location"
  urls = ["http://169.254.169.254/metadata/instance/compute/location?api-version=2025-04-07&format=text"]
  method = "GET"
  timeout = "10s"
  interval = "300s"
  data_format = "value"
  data_type = "string"
  
  [inputs.http.headers]
    Metadata = "true"
    User-Agent = "telegraf-azure-location/1.0"

  [inputs.http.tags]
    azure_service = "vm_location"
    cloud_provider = "azure"
    metric_source = "imds"

# Custom processor to add event status metrics
# Temporarily disabled due to Starlark "file name too long" error
# [[processors.starlark]]
#   script = "def apply(metric): metric.fields['processed'] = 1; return metric"

# Health check for the Azure IMDS endpoint
# Uses minimal endpoint to check IMDS availability without sensitive data
[[inputs.http_response]]
  name_override = "azure_imds_health"
  
  ## URLs to check (using minimal metadata endpoint)
  urls = [
    "http://169.254.169.254/metadata/instance/compute/location?api-version=2025-04-07&format=text"
  ]

  ## HTTP method
  method = "GET"

  ## Required HTTP headers for IMDS
  [inputs.http_response.headers]
    Metadata = "true"
    User-Agent = "telegraf-imds-health/1.0"

  ## Expected response status code
  expected_response_status_code = "200"

  ## HTTP request timeout (Microsoft recommends max 10s)
  timeout = "10s"

  ## Interval for health checks (respects rate limiting)
  interval = "60s"
  
  ## Response time tracking
  response_timeout = "10s"

  ## Additional tags
  [inputs.http_response.tags]
    service = "azure_imds"
    check_type = "health"
    cloud_provider = "azure"